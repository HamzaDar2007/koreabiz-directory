import { Test, TestingModule } from '@nestjs/testing';\nimport { getRepositoryToken } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\nimport { EnterprisesService } from '../src/modules/enterprises/enterprises.service';\nimport { Enterprise } from '../src/modules/enterprises/entities/enterprise.entity';\nimport { AuditService } from '../src/modules/audit/audit.service';\nimport { MeilisearchService } from '../src/integrations/meilisearch/meilisearch.service';\nimport { NotFoundException, ForbiddenException } from '@nestjs/common';\n\ndescribe('EnterprisesService', () => {\n  let service: EnterprisesService;\n  let repository: Repository<Enterprise>;\n  let auditService: AuditService;\n  let meilisearchService: MeilisearchService;\n\n  const mockRepository = {\n    findOne: jest.fn(),\n    save: jest.fn(),\n    create: jest.fn(),\n    createQueryBuilder: jest.fn(() => ({\n      where: jest.fn().mockReturnThis(),\n      leftJoinAndSelect: jest.fn().mockReturnThis(),\n      skip: jest.fn().mockReturnThis(),\n      take: jest.fn().mockReturnThis(),\n      getManyAndCount: jest.fn(),\n    })),\n  };\n\n  const mockAuditService = {\n    log: jest.fn(),\n  };\n\n  const mockMeilisearchService = {\n    indexEnterprise: jest.fn(),\n  };\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        EnterprisesService,\n        {\n          provide: getRepositoryToken(Enterprise),\n          useValue: mockRepository,\n        },\n        {\n          provide: AuditService,\n          useValue: mockAuditService,\n        },\n        {\n          provide: MeilisearchService,\n          useValue: mockMeilisearchService,\n        },\n      ],\n    }).compile();\n\n    service = module.get<EnterprisesService>(EnterprisesService);\n    repository = module.get<Repository<Enterprise>>(getRepositoryToken(Enterprise));\n    auditService = module.get<AuditService>(AuditService);\n    meilisearchService = module.get<MeilisearchService>(MeilisearchService);\n  });\n\n  afterEach(() => {\n    jest.clearAllMocks();\n  });\n\n  describe('findOne', () => {\n    it('should return an enterprise when found', async () => {\n      const mockEnterprise = {\n        id: '123',\n        name: 'Test Enterprise',\n        status: 'ACTIVE',\n      };\n\n      mockRepository.findOne.mockResolvedValue(mockEnterprise);\n\n      const result = await service.findOne('123');\n\n      expect(result).toEqual(mockEnterprise);\n      expect(mockRepository.findOne).toHaveBeenCalledWith({\n        where: { id: '123', status: 'ACTIVE' },\n        relations: ['city', 'categories', 'hours', 'media'],\n      });\n    });\n\n    it('should throw NotFoundException when enterprise not found', async () => {\n      mockRepository.findOne.mockResolvedValue(null);\n\n      await expect(service.findOne('123')).rejects.toThrow(NotFoundException);\n    });\n  });\n\n  describe('update', () => {\n    it('should update enterprise when user is owner', async () => {\n      const mockEnterprise = {\n        id: '123',\n        name: 'Test Enterprise',\n        ownerUserId: 'user123',\n      };\n      const updateDto = { name: 'Updated Enterprise' };\n\n      mockRepository.findOne.mockResolvedValue(mockEnterprise);\n      mockRepository.save.mockResolvedValue({ ...mockEnterprise, ...updateDto });\n\n      const result = await service.update('123', updateDto, 'user123');\n\n      expect(result.name).toBe('Updated Enterprise');\n      expect(mockMeilisearchService.indexEnterprise).toHaveBeenCalled();\n    });\n\n    it('should throw ForbiddenException when user is not owner', async () => {\n      const mockEnterprise = {\n        id: '123',\n        name: 'Test Enterprise',\n        ownerUserId: 'user123',\n      };\n\n      mockRepository.findOne.mockResolvedValue(mockEnterprise);\n\n      await expect(\n        service.update('123', { name: 'Updated' }, 'user456')\n      ).rejects.toThrow(ForbiddenException);\n    });\n  });\n\n  describe('create', () => {\n    it('should create and index new enterprise', async () => {\n      const createDto = {\n        name: 'New Enterprise',\n        description: 'Test description',\n      };\n      const mockEnterprise = {\n        id: '123',\n        ...createDto,\n        ownerUserId: 'user123',\n      };\n\n      mockRepository.create.mockReturnValue(mockEnterprise);\n      mockRepository.save.mockResolvedValue(mockEnterprise);\n\n      const result = await service.create(createDto, 'user123');\n\n      expect(result).toEqual(mockEnterprise);\n      expect(mockRepository.create).toHaveBeenCalledWith({\n        ...createDto,\n        ownerUserId: 'user123',\n      });\n      expect(mockMeilisearchService.indexEnterprise).toHaveBeenCalledWith(mockEnterprise);\n    });\n  });\n});